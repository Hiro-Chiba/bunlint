# 開発計画：テキスト変換・語尾調整サービス

## 1. プロジェクト概要

- Next.js 14（App Router）をベースとしたWebアプリケーションをVercelにデプロイする。
- テキスト入力に対して以下の機能を提供する：
  - 文字数・単語数のカウント表示。
  - 句読点を「，」「．」スタイルへ一括変換するトグル機能。
  - Gemini APIを用いた語尾変換（だ・である調／です・ます調など）の自動処理。
- ユーザー操作履歴や設定はNeon（PostgreSQL）に保存し、後日分析やプリセット呼び出しに利用できるようにする。
- UIはできる限りシンプルに保ちつつ、UXを最大限に高めることを設計指針とする。

## 2. 必要なサービス・環境準備

1. **Google AI StudioでのGemini APIキー取得**
   - `.env`に`GEMINI_API_KEY`を設定。
2. **NeonでのPostgreSQLプロジェクト作成**
   - 接続情報を`.env`に`DATABASE_URL`として保存。
3. **Vercelプロジェクト設定**
   - 環境変数（`GEMINI_API_KEY`、`DATABASE_URL`）をVercelのDashboardで設定。

## 3. Next.jsアプリ構成

- ディレクトリ：`app/`を利用。以下のページ・コンポーネントを想定。
  - `app/page.tsx`：メインエディタページ。
  - `components/TextEditor.tsx`：入力と結果表示を統合したコンポーネント（実装済み）。
  - `components/StatsPanel.tsx`：文字数/単語数/文章数などの統計情報表示（実装済み）。
  - `components/TransformationControls.tsx`：句読点変換や語尾調整のトグル・セレクト（Gemini API 呼び出しまで実装済み）。
  - `components/HistoryList.tsx`：最新の変換履歴を表示（ブラウザーの localStorage で暫定保存済み、Neon 連携は今後対応）。
  - `lib/gemini.ts`：Gemini APIクライアント。
  - `lib/db.ts`：Neon (PostgreSQL) 接続ロジック。
  - `app/api/transform/route.ts`：語尾変換APIルート。
  - `app/api/history/route.ts`：履歴のCRUD API。
- UI：Tailwind CSSを導入し、Vercelでのビルドに合わせた設定を`tailwind.config.ts`に記載。

## 4. 機能仕様

### 4.1 文字数カウント

- 入力テキストが変化するたびに即時更新。
- 文字数、単語数（スペース区切り）、文数（「。」「．」「!」「?」等で分割）を表示。
- 現状の単語数計算ロジックに不具合があるため、スペースや改行を考慮した堅牢な再実装を行い、ユニットテストを追加して再発防止を図る（未実装）。

### 4.2 句読点変換

- 入力テキストの句読点をリアルタイムに`、`→`，`、`。`→`．`へ変換するトグルスイッチ。
- 逆変換（`，`→`、`、`．`→`。`）にも対応し、ユーザーが元に戻せるようにする。
- 入力の最終状態は常にエディタに反映。

### 4.3 語尾調整（Gemini API）

- ユーザーが選択したスタイル（例：だ・である調／です・ます調）に基づいて、Gemini APIにプロンプトを生成。
- APIレスポンスを整形し、エディタに反映。
- 過度な変換を防ぐため、元テキストとのDiffを表示するか、変更箇所をハイライトする機能を検討。
- Gemini API による変更箇所を緑色などの背景色でハイライトする差分表示機能を実装する。
- APIコールは`use server`関数またはAPIルートで実装し、フロントから呼び出す。

### 4.4 履歴管理（Neon）

- テーブル例：`transform_history`
  - `id` (UUID, primary key)
  - `input_text` (text)
  - `output_text` (text)
  - `style` (text)
  - `punctuation_mode` (enum)
  - `created_at` (timestamp with time zone, default now)
- ユーザー操作ごとに履歴を保存し、最新10件程度を画面に表示。
- 将来的なユーザー認証を考慮し、`user_id`カラムを追加できるようスキーマを設計。
- ブラウザーでは `localStorage` を用いた最新10件の暫定保存機構を実装済み。Neon 連携時に置き換える。
- 認証または識別情報を用いてユーザーごとに変換履歴が分離されるようにする（未実装）。
- DB側で作成から1時間を経過した履歴レコードを自動削除し、ストレージ使用量を抑制する（未実装）。

### 4.5 AI変換の巻き戻し機能

- 直近のAI変換結果を元のテキストに戻す「戻す」操作を提供する（未実装）。
- 履歴と連動し、任意の履歴エントリを復元できるようにする（未実装）。
- UI上では変換結果カードやボタンを追加し、ロールバック操作が分かりやすい導線になるよう工夫する。

### 4.6 人間らしい文章構成最適化（新スタイル）

- 「です・ます」「だ・である」以外の新しいスタイルとして、文章全体の構成やリズムを人間らしく調整するモードを追加する（未実装）。
- Gemini APIのプロンプト設計を拡張し、段落構成や接続詞の改善、語順の微調整などを行う。
- UIのスタイル選択に新モードを追加し、既存機能と混同しないよう説明やサンプルを提供する。
- 人間らしい構成に変換する際のゴールを「人間らしい変換（です・ます）」「人間らしい変換（だ・である）」の2種類に分け、ユーザーが明確に選択できるようにする（未実装）。
- モード選択は既存の語尾変換スタイルと同じドロップダウンに統合しつつ、視覚的にグルーピングして違いが分かるようラベルや区切りを設ける。
- Gemini APIに送るプロンプトテンプレートをそれぞれのモード専用に用意し、段落構成の調整と語尾スタイルの整合性が両立するようプロンプト例を設計する。
- 変換履歴には選択したモード名（です・ます／だ・である）を保存し、後からどのスタイルを適用したか追跡できるようにする。
- 単体テストではGemini API呼び出し時にモード別のプロンプトが組み立てられているかを検証し、UIコンポーネントのスナップショットテストで選択肢が表示されることを確認する。

### 4.7 AIチェッカー機能

- 入力テキストに対し、AI生成らしさを数値（例：0〜100%）で可視化する分析機能を提供する（未実装）。
- Gemini APIもしくは専用モデルを用いた推定ロジックをサーバーサイドで実行し、結果をフロントに返す。
- 利用者が過去の変換結果と比較できるよう、履歴にAI利用率を付帯情報として保存する（未実装）。
- 日次利用回数が減らない不具合を解消し、クライアントとサーバーで一致した残回数が表示されるようにする。
- 利用回数の制御ロジックに対する単体テストを追加し、トークン使用量の最適化とバグ再発防止を図る。

## 5. 実装ステップ

1. Next.jsプロジェクト作成と基本設定（完了）
   - `npx create-next-app@latest`で初期化。
   - TypeScript, ESLint, Tailwindを有効化。
   - Vercelデプロイ設定確認。
2. UIレイアウトと状態管理（初期版完了）
   - `TextEditor`コンポーネントを実装し、`useState`で入力管理。
   - `StatsPanel`と`TransformationControls`を配置。
3. 文字数カウント・句読点変換ロジック
   - 文字数/単語数計算のユーティリティ作成（`lib/text.ts`、実装済み）。
   - 単語数カウントロジックの不具合を修正し、境界条件に対応したテストを追加する（未実装）。
   - 句読点変換ロジックを`lib/punctuation.ts`に分離し、ユニットテストを作成（実装済み）。
4. Gemini API連携
   - `lib/gemini.ts`にAPIクライアント実装。
   - `app/api/transform/route.ts`でPOSTリクエストに応答。
   - フロントから`fetch`で呼び出し結果を反映。
5. Neon接続と履歴API
   - `lib/db.ts`でNeonへの接続を設定（`@neondatabase/serverless`など使用）。
   - PrismaまたはDrizzleを導入してスキーマ管理し、マイグレーションを実行。
   - `app/api/history/route.ts`で履歴取得・登録を実装。
   - ユーザーごとの履歴分離と1時間での自動削除ロジックを実装。
6. UI改善とエラーハンドリング
   - APIエラー時のトースト表示、ローディング状態管理。
   - 語尾調整結果のDiff表示。
   - AI変換の巻き戻しUIと操作を実装。
   - 人間らしい文章構成最適化モードをUIに組み込む。
   - AIチェッカーの結果表示コンポーネントを追加。
   - 統計情報カードにバッジと色分けを再導入し、値の大小を視覚的に把握できるようにする。
7. テスト
   - 単体テスト：文字数計算・句読点変換ロジック。
   - E2Eテスト（Playwright）で主要フローを確認。
   - 履歴の自動削除やユーザー分離、巻き戻し、AIチェッカーの挙動に対するテストケースを追加。
8. 公開準備の暫定ブランディング対応
   - 仮のfaviconやタイトル、説明文などを日本語で整備し、公開前のイメージを掴めるようにする。
   - 実サービス開始時に差し替えやすいよう、配置場所と編集手順をドキュメント化する。

## 6. デプロイと運用

- Vercelへのデプロイ後、Neonの接続制限やGemini APIのクオータを監視。
- エラーログはVercelのLog DrainsやSentry導入を検討。
- 将来的にはユーザー認証（NextAuth.js）追加や、変換スタイルのカスタマイズ機能を拡張予定。

## 7. 実装進捗チェックリスト

- [x] Next.jsプロジェクトの初期化と基本設定
- [x] 文字数・単語数カウント機能の実装
- [ ] 単語数カウントロジックの不具合修正
- [x] 句読点変換トグルの実装
- [x] Gemini APIによる語尾変換機能の実装
- [x] ブラウザーでの暫定的な履歴保存（localStorage）
- [ ] Neonを用いた履歴管理機能の実装
- [ ] 履歴のユーザー分離と1時間での自動削除
- [ ] AI変換の巻き戻し機能
- [ ] 人間らしい文章構成最適化モード
- [ ] AIチェッカー機能
- [ ] シンプルなUI構成とUX最適化の完了
- [x] 主要ユーティリティの単体テスト整備
- [ ] E2Eテストの整備
- [ ] Vercelへのデプロイと環境変数設定の確認
- [ ] 運用監視とエラーログ収集体制の確立

> チェックボックスは各機能を実装したタイミングで更新し、進捗管理に活用する。
> 各チェックボックスを完了にした際には必ず`npm run build`を実行し、ビルドエラーが発生しないことを確認する。

## 8. 開発プロセス上の注意点

- テストは可能な限り充実させる。主要なユーティリティの単体テスト、APIルートの統合テスト、UI操作のE2Eテストを計画し、将来的に回帰を防ぐ。
- コミットは細かく分割し、必ず日本語で簡潔なメッセージを付ける。例：「文字数計算のテスト追加」「句読点変換ロジックを調整」など。
- `.env`やVercel上の環境変数設定はユーザー側で実施するため、リポジトリではダミーやサンプル値を保持しない。必要な変数はドキュメントや残作業リストで周知する。
- 作業完了時には、ユーザーが残りの設定作業を把握できるよう、やるべき事項をまとめたMarkdownファイルを作成・更新する。
